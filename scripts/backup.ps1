<#PSScriptInfo
.VERSION 1.0.0
.GUID 5eadc648-e218-48d9-b264-f96f01f81434
.AUTHOR Code Dx
#>

<#
.SYNOPSIS
Creates a backup volume for the data in a Code Dx Docker Compose install

.DESCRIPTION
This script creates a backup of the appdata and database volumes created automatically
by a Code Dx docker-compose install. These backups can then be used by a restore script.

.PARAMETER ProjectName
The name used for prefacing volume and container names.

The project name is used by docker-compose and preceeds the name of docker resources
such as containers and volumes. By default, this is set to the name of the
containing directory of the compose file.

If you have multiple Code Dx Docker Compose installations, you should specify the project name to refer
to a specific one.

By default, this is 'codedx-docker'.

.PARAMETER UsingExternalDb
This switch's presence indicates this Code Dx Docker Compose install is utilizing an external database,
therefore, the backup script will not attempt to create a backup of the database.

The generated backup volume will only contain a backup of the appdata.

.PARAMETER AppDataVolumeName
By default, this is the project name + '_' + 'codedx-appdata-volume'.

If the tomcat container depends on a volume name other than this, the name from the docker-compose config file should be specified with this parameter. A named volume will be
generated with the name provided by this parameter.

.PARAMETER DbDataVolumeName
By default, this is the project name + '_' + 'codedx-database-volume'. Affects behavior when -UsingExternalDb is false.

If the database container depends on a volume name other than the default, the name from the docker-compose config file should be specified with this parameter. A named volume will be
generated with the name provided by this parameter.

.PARAMETER TomcatContainerName
By default, this is the project name + '_' + 'codedx-tomcat_1'.

If the docker-compose config file specifies a service name other than 'codedx-tomcat', that updated value should be specified with this parameter.

.PARAMETER DbContainerName
By default, this is the project name + '_' + 'codedx-db_1'. Affects behavior when -UsingExternalDb is false.

If the docker-compose config file specifies a service name other than 'codedx-db', that updated value should be specified with this parameter.

.PARAMETER BackupVolumeName
The name of the backup volume generated by this script. The generated volume will be referenced
by this name when restoring from it.

.LINK
https://github.com/codedx/codedx-docker#creating-a-backup

#>

param (
        [Alias('p')]
        [string] $ProjectName = 'codedx-docker',
        [string] $AppDataVolumeName = "$ProjectName`_codedx-appdata-volume",
        [string] $DbDataVolumeName = "$ProjectName`_codedx-database-volume",
        [string] $CodeDxTomcatServiceName = "codedx-tomcat",
        [string] $CodeDxDbServiceName = "codedx-db",
        [string] $TomcatContainerName = "$ProjectName`_$CodeDxTomcatServiceName`_1",
        [string] $DbContainerName = "$ProjectName`_$CodeDxDbServiceName`_1",
        [string] $ComposeConfigPath = $(Resolve-Path "$PSScriptRoot\..\docker-compose.yml").Path,
        [string] $BashCapableImage,
        [switch] $SkipConfirmation,
        [Parameter(Mandatory=$true)]
        [string] $BackupVolumeName
)

$ErrorActionPreference = 'Stop'
$VerbosePreference = 'Continue'

Set-PSDebug -Strict

. $PSScriptRoot/common.ps1

$BashCapableImage = $BashCapableImage ? $BashCapableImage : (Get-TomcatImage $ComposeConfigPath)
$UsingExternalDb = Test-UsingExternalDb $ComposeConfigPath

function Get-BackupConfirmation([string] $BackupName) {
    if (Test-VolumeExists $BackupName) {
        if (!$SkipConfirmation) {
            $continueAnswer = Read-Host -Prompt "A backup volume with the name $BackupName already exists, continuing will overwrite this backup. Continue? (y/n)"
            # Do a case insensitive string equality check to see if the user wants to proceed else exit
            if (-not ($continueAnswer -ieq "y" -or $continueAnswer -ieq "yes")) {
                Exit 0
            }
        }
        # Indicates the user has chosen to overwrite an existing backup
        1
    }
    else {
        # Backup doesn't already exist
        0
    }
}

function Test-VolumeAppData([string] $VolumeName) {
    if (Test-VolumeExists $VolumeName) {
        [bool] $Result = docker run -u 0 --rm -v "$VolumeName`:/appdata" $BashCapableImage bash -c "
        cd /appdata &&
        ls &&
        if [ -f codedx.props ] && [ -f logback.xml ]; then
            echo 1
        else
            echo 0
        fi"
        if ($LASTEXITCODE -ne 0) {
            throw "Unable to test the existence of appdata in $VolumeName"
        }
        $Result
    }
    else {
        $false
    }
}

function Test-VolumeDatabase([string] $VolumeName) {
    if (Test-VolumeExists $VolumeName) {
        [bool]$Result = docker run -u 0 --rm -v "$VolumeName`:/db" $BashCapableImage bash -c "
        cd /db &&
        if [ -d 'data' ] && [ -d 'data/mysql' ]; then
            echo 1
        else
            echo 0
        fi"
        if ($LASTEXITCODE -ne 0) {
            throw "Unable to test the existence of database data in $VolumeName"
        }
        $Result
    }
    else {
        $false
    }
}

function New-BackupVolume([string] $BackupName) {
    $OverwriteBackup = Get-BackupConfirmation $BackupName

    if ($OverwriteBackup) {
        Write-Verbose "User has chosen to overwrite existing backup volume $BackupName, overwriting..."
        docker run -u 0 --rm -v "$BackupName`:/backup" $BashCapableImage bash -c "rm -f /backup/*.tar"
        if ($LASTEXITCODE -ne 0) {
			throw "Unable to delete contents of $BackupName for overwrite"
		}
    }

    Write-Verbose "Creating backup of appdata volume, $AppDataVolumeName..."
    # Create backup of appdata. tar -C is used to set the location for the archive, by doing this we don't store parent directories containing
    # our desired folder. Instead, it's just the contents of the volume in the archive.
    docker run -u 0 --rm -v "$BackupName`:/backup" -v "$AppDataVolumeName`:/appdata" $BashCapableImage bash -c "tar -C /appdata -cvzf /backup/$AppDataArchiveName ."
    if ($LASTEXITCODE -ne 0) {
        throw "Unable to backup appdata volume $AppDataVolumeName"
    }
    # Create backup of DB if it's being used according to the -UsingExternalDb switch
    if (!$UsingExternalDb) {
        Write-Verbose "Creating backup of DB volume, $DbDataVolumeName..."
        docker run -u 0 --rm -v "$BackupName`:/backup" -v "$DbDataVolumeName`:/dbdata" $BashCapableImage bash -c "tar -C /dbdata -cvzf /backup/$DbDataArchiveName ."
        if ($LASTEXITCODE -ne 0) {
            throw "Unable to backup database volume $AppDataVolumeName"
        }
    }
    else {
        Write-Verbose 'Skipping backing up database due to external database being used'
    }
}

Test-Runnable $TomcatContainerName $DbContainerName $AppDataVolumeName $DbDataVolumeName $ComposeConfigPath $BashCapableImage

Write-Verbose "Checking $AppDataVolumeName is a valid Code Dx appdata volume"
if (-not (Test-VolumeAppData $AppDataVolumeName)) {
    throw "The provided appdata volume $AppDataVolumeName does not appear to be Code Dx appdata. Example missing files include codedx.props and logback.xml."
}
if (!$UsingExternalDb) {
    Write-Verbose "Checking $DbDataVolumeName is a valid Code Dx database volume"
    if (-not (Test-VolumeDatabase $DbDataVolumeName)) {
        throw "The provided database volume $DbDataVolumeName does not appear to be a Code Dx database. Failed to locate system databases such as mysql."
    }
}

Write-Verbose "Creating Backup Volume $BackupVolumeName..."
New-BackupVolume $BackupVolumeName

if ($LASTEXITCODE -eq 0) {
    Write-Verbose "Successfully created backup volume $BackupVolumeName"
}
